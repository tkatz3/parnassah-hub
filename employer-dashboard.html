<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employer Dashboard — ParnassaHub</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { 50:'#ebf3ff',100:'#d6e8ff',200:'#add0ff',300:'#85b8ff',400:'#5c9ef5',500:'#2877C9',600:'#1d62aa',700:'#154d8b' } },
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    input:focus, select:focus, textarea:focus { outline: none; }
    /* Toggle switch */
    .toggle-switch { position:relative; display:inline-flex; align-items:center; cursor:pointer; gap:8px; }
    .toggle-switch input { opacity:0; width:0; height:0; position:absolute; }
    .toggle-track { width:36px; height:20px; background:#e5e7eb; border-radius:10px; transition:.2s; flex-shrink:0; }
    .toggle-switch input:checked ~ .toggle-track { background:#2877C9; }
    .toggle-knob { position:absolute; left:2px; top:2px; width:16px; height:16px; background:#fff; border-radius:50%; transition:.2s; box-shadow:0 1px 3px rgba(0,0,0,.2); }
    .toggle-switch input:checked ~ .toggle-track .toggle-knob { transform:translateX(16px); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">

<div class="flex min-h-screen">

  <!-- SIDEBAR -->
  <aside class="w-56 shrink-0 bg-white border-r border-gray-100 flex flex-col py-5 px-4 fixed inset-y-0 left-0 z-30 hidden lg:flex">
    <a href="index.html" class="mb-8"><img src="parnassah hub.png" alt="ParnassaHub" class="h-14 w-auto" /></a>
    <nav class="flex-1 space-y-1 text-sm">
      <a href="employer-dashboard.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-brand-50 text-brand-600 font-semibold">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        Overview
      </a>
      <a href="post-job.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        Post a Job
      </a>
    </nav>
    <div class="border-t border-gray-100 pt-4 mt-4">
      <div class="flex items-center gap-2.5 mb-3">
        <div id="sidebar-avatar" class="w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center text-xs font-bold text-brand-600">—</div>
        <div>
          <p id="sidebar-company" class="text-xs font-semibold text-gray-900 leading-none">—</p>
          <p id="sidebar-name" class="text-xs text-gray-400 mt-0.5">—</p>
        </div>
      </div>
      <button onclick="signOut()" class="flex items-center gap-2 text-xs text-gray-500 hover:text-gray-700 px-2 py-1.5 rounded-lg hover:bg-gray-50 transition w-full">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
        Sign out
      </button>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="flex-1 lg:ml-56">

    <!-- Mobile header -->
    <header class="lg:hidden bg-white border-b border-gray-100 px-4 h-14 flex items-center justify-between">
      <a href="index.html"><img src="parnassah hub.png" alt="ParnassaHub" class="h-12 w-auto" /></a>
      <a href="post-job.html" class="text-xs font-semibold text-white bg-brand-500 px-3 py-1.5 rounded-lg">+ Post Job</a>
    </header>

    <div class="px-4 sm:px-8 py-8 max-w-5xl">

      <!-- Header -->
      <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
        <div>
          <h1 class="text-2xl font-extrabold text-gray-900">Employer Dashboard</h1>
          <p id="dash-subtitle" class="text-sm text-gray-500 mt-1">Loading…</p>
        </div>
        <a href="post-job.html" class="inline-flex items-center gap-2 px-5 py-2.5 bg-brand-500 hover:bg-brand-600 text-white text-sm font-semibold rounded-xl transition shadow-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          Post a Job
        </a>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-2 gap-4 mb-10">
        <div class="bg-white border border-gray-200 rounded-2xl p-5">
          <p class="text-xs text-gray-500 mb-1 font-medium">Active Listings</p>
          <p id="stat-active" class="text-3xl font-extrabold text-gray-900">—</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-2xl p-5">
          <p class="text-xs text-gray-500 mb-1 font-medium">Total Listings</p>
          <p id="stat-total" class="text-3xl font-extrabold text-brand-500">—</p>
        </div>
      </div>

      <!-- MY LISTINGS -->
      <section id="listings" class="mb-10">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <h2 class="text-lg font-bold text-gray-900">My Listings</h2>
          <div class="flex items-center gap-4">
            <label class="toggle-switch text-xs text-gray-500 font-medium">
              <input type="checkbox" id="show-inactive-toggle" onchange="renderListingsTable()" />
              <span class="toggle-track"><span class="toggle-knob"></span></span>
              Show inactive
            </label>
            <a href="post-job.html" class="text-xs text-brand-500 hover:text-brand-600 font-medium flex items-center gap-1">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              New listing
            </a>
          </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-2xl overflow-hidden">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-100 bg-gray-50/50 text-xs text-gray-500 font-semibold uppercase tracking-wider">
                <th class="text-left px-5 py-3">Position</th>
                <th class="text-left px-4 py-3 hidden sm:table-cell">Category</th>
                <th class="text-left px-4 py-3 hidden md:table-cell">Type</th>
                <th class="text-left px-4 py-3 hidden lg:table-cell">Status</th>
                <th class="px-4 py-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="listings-body" class="divide-y divide-gray-100">
              <tr><td colspan="5" class="px-5 py-8 text-center text-sm text-gray-400">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- JOB EDIT MODAL -->
<div id="jobEditModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeJobEditModal()"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4 overflow-y-auto pointer-events-none">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl pointer-events-auto my-8">
      <div class="flex items-center justify-between p-6 border-b border-gray-100">
        <h2 id="job-modal-title" class="text-lg font-bold text-gray-900">Edit Listing</h2>
        <button onclick="closeJobEditModal()" class="w-8 h-8 rounded-xl border border-gray-200 flex items-center justify-center text-gray-400 hover:text-gray-600 transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="p-6 space-y-4 max-h-[65vh] overflow-y-auto">
        <input type="hidden" id="job-edit-id" />
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Job Title *</label>
            <input id="job-f-title" type="text" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Category *</label>
            <select id="job-f-category" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400 appearance-none bg-white">
              <option value="">Select…</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Vacancy Type *</label>
            <select id="job-f-type" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400 appearance-none bg-white">
              <option value="">Select…</option>
              <option>Full Time</option><option>Part-Time</option><option>Commission</option><option>Volunteer</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Location *</label>
            <select id="job-f-location" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400 appearance-none bg-white">
              <option value="">Select…</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Status</label>
            <select id="job-f-active" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400 appearance-none bg-white">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="draft">Draft</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Salary Min</label>
            <input id="job-f-sal-min" type="number" placeholder="e.g. 50000" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Salary Max</label>
            <input id="job-f-sal-max" type="number" placeholder="e.g. 70000" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Pay Period</label>
            <select id="job-f-period" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400 appearance-none bg-white">
              <option value="">Select…</option>
              <option>Annual</option><option>Hourly</option><option>Daily</option>
              <option>Commission Only</option><option>Unpaid / Volunteer</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Contact Email</label>
            <input id="job-f-email" type="email" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Contact Phone</label>
            <input id="job-f-phone" type="tel" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400" />
          </div>
          <div class="col-span-2">
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Job Description *</label>
            <textarea id="job-f-desc" rows="5" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400 resize-none leading-relaxed"></textarea>
          </div>
          <div class="col-span-2">
            <label class="block text-xs font-medium text-gray-600 mb-1.5">Requirements</label>
            <textarea id="job-f-req" rows="3" class="w-full px-3.5 py-2.5 border border-gray-200 rounded-xl text-sm focus:border-brand-400 resize-none leading-relaxed"></textarea>
          </div>
        </div>
      </div>
      <div class="p-6 border-t border-gray-100 flex gap-3">
        <button onclick="closeJobEditModal()" class="flex-1 py-2.5 border border-gray-200 text-gray-600 text-sm font-medium rounded-xl hover:bg-gray-50 transition">Cancel</button>
        <button id="job-save-btn" onclick="saveJob()" class="flex-1 py-2.5 bg-brand-500 hover:bg-brand-600 text-white text-sm font-semibold rounded-xl transition">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script src="js/supabase-client.js"></script>
<script>
  let allJobs = []
  let companyId = null
  let categories = []
  let locations  = []

  ;(async () => {
    const profile = await requireRole('employer', 'signup.html')
    if (!profile) return

    // Load company
    const { data: company } = await sb.from('companies').select('*').eq('user_id', profile.id).single()
    if (!company) {
      document.getElementById('dash-subtitle').textContent = 'No company found. Please contact support.'
      return
    }
    companyId = company.id

    // Fill sidebar
    document.getElementById('sidebar-avatar').textContent = initials(company.name)
    document.getElementById('sidebar-company').textContent = company.name
    document.getElementById('sidebar-name').textContent = `${profile.first_name || ''} ${profile.last_name || ''}`.trim() || profile.id.slice(0,8)
    document.getElementById('dash-subtitle').textContent = `${company.name} — Manage your listings`

    // Load filter options for edit modal
    const [catRes, locRes] = await Promise.all([
      sb.from('job_categories').select('name').order('sort_order'),
      sb.from('job_locations').select('name').order('sort_order'),
    ])
    categories = (catRes.data || []).map(r => r.name)
    locations  = (locRes.data || []).map(r => r.name)

    const catSel = document.getElementById('job-f-category')
    categories.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; catSel.appendChild(o) })

    const locSel = document.getElementById('job-f-location')
    locations.forEach(l => { const o = document.createElement('option'); o.value = l; o.textContent = l; locSel.appendChild(o) })

    // Load all jobs for this company
    await loadAllJobs()
  })()

  async function loadAllJobs() {
    const { data: jobs } = await sb.from('jobs').select('*').eq('company_id', companyId).order('created_at', { ascending: false })
    allJobs = jobs || []
    document.getElementById('stat-active').textContent = allJobs.filter(j => j.status === 'active').length
    document.getElementById('stat-total').textContent  = allJobs.filter(j => j.status !== 'draft').length
    renderListingsTable()
  }

  function renderListingsTable() {
    const showInactive = document.getElementById('show-inactive-toggle').checked
    const visibleJobs  = showInactive ? allJobs : allJobs.filter(j => j.status === 'active')
    const tbody = document.getElementById('listings-body')

    if (!visibleJobs.length) {
      const msg = allJobs.length
        ? 'No active listings. Toggle "Show inactive" to see closed listings and drafts.'
        : 'No listings yet. <a href="post-job.html" class="text-brand-500 font-medium">Post one now →</a>'
      tbody.innerHTML = `<tr><td colspan="5" class="px-5 py-8 text-center text-sm text-gray-400">${msg}</td></tr>`
      return
    }

    tbody.innerHTML = visibleJobs.map(job => {
      const status = job.status || (job.active ? 'active' : 'inactive')
      const rowCls = status === 'active' ? '' : 'opacity-60 bg-gray-50/50'
      const statusBadge = status === 'active'
        ? '<span class="text-xs font-semibold px-2.5 py-1 bg-green-50 text-green-700 rounded-full">Active</span>'
        : status === 'draft'
        ? '<span class="text-xs font-semibold px-2.5 py-1 bg-amber-50 text-amber-600 rounded-full">Draft</span>'
        : '<span class="text-xs font-semibold px-2.5 py-1 bg-gray-100 text-gray-500 rounded-full">Inactive</span>'

      const actionBtn = status === 'active'
        ? `<button onclick="toggleJobStatus('${job.id}', true)" class="text-xs text-amber-500 hover:text-amber-600 font-medium">Close</button>`
        : status === 'draft'
        ? `<button onclick="publishDraft('${job.id}')" class="text-xs text-green-600 hover:text-green-700 font-medium">Publish</button>`
        : `<button onclick="toggleJobStatus('${job.id}', false)" class="text-xs text-green-600 hover:text-green-700 font-medium">Reopen</button>`

      return `
      <tr class="hover:bg-gray-50/50 transition ${rowCls}">
        <td class="px-5 py-4">
          <p class="font-semibold text-gray-900">${job.title}</p>
          <p class="text-xs text-gray-400 mt-0.5">${job.location || '—'}</p>
        </td>
        <td class="px-4 py-4 hidden sm:table-cell text-xs text-gray-500">${job.category || '—'}</td>
        <td class="px-4 py-4 hidden md:table-cell">
          <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${vacancyBadgeClass(job.vacancy_type)}">${job.vacancy_type || '—'}</span>
        </td>
        <td class="px-4 py-4 hidden lg:table-cell">${statusBadge}</td>
        <td class="px-4 py-4 text-right">
          <div class="flex items-center gap-3 justify-end">
            <a href="find-jobs.html?job=${job.id}" class="text-xs text-gray-400 hover:text-gray-600 font-medium">View</a>
            <button onclick="openEditModal('${job.id}')" class="text-xs text-brand-500 hover:text-brand-600 font-medium">Edit</button>
            <button onclick="cloneJob('${job.id}')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">Clone</button>
            ${actionBtn}
          </div>
        </td>
      </tr>`
    }).join('')
  }

  function vacancyBadgeClass(type) {
    return { 'Full Time': 'bg-green-50 text-green-700', 'Part-Time': 'bg-purple-50 text-purple-700', 'Commission': 'bg-amber-50 text-amber-700', 'Volunteer': 'bg-blue-50 text-blue-700' }[type] || 'bg-gray-100 text-gray-600'
  }

  async function toggleJobStatus(jobId, currentlyActive) {
    if (!confirm(`${currentlyActive ? 'Close' : 'Reopen'} this listing?`)) return
    const payload = currentlyActive
      ? { active: false, status: 'inactive' }
      : { active: true,  status: 'active'  }
    const { error } = await sb.from('jobs').update(payload).eq('id', jobId)
    if (error) { showToast('Error: ' + error.message, 'error'); return }
    showToast(currentlyActive ? 'Listing closed.' : 'Listing reopened.')
    await loadAllJobs()
  }

  async function publishDraft(jobId) {
    if (!confirm('Publish this draft listing? It will become visible to job seekers.')) return
    const { error } = await sb.from('jobs').update({ active: true, status: 'active' }).eq('id', jobId)
    if (error) { showToast('Error: ' + error.message, 'error'); return }
    showToast('Listing published!')
    await loadAllJobs()
  }

  async function cloneJob(jobId) {
    const job = allJobs.find(j => j.id === jobId)
    if (!job) return
    const { id, created_at, posted_at, ...rest } = job
    const clone = { ...rest, title: job.title + ' (Copy)', active: false, status: 'draft' }
    const { error } = await sb.from('jobs').insert(clone)
    if (error) { showToast('Error cloning: ' + error.message, 'error'); return }
    showToast('Listing cloned as draft.')
    // Show inactive toggle so user can see the clone
    document.getElementById('show-inactive-toggle').checked = true
    await loadAllJobs()
  }

  function openEditModal(jobId) {
    const job = allJobs.find(j => j.id === jobId)
    if (!job) return
    document.getElementById('job-edit-id').value    = job.id
    document.getElementById('job-modal-title').textContent = 'Edit Listing'
    document.getElementById('job-f-title').value    = job.title || ''
    document.getElementById('job-f-category').value = job.category || ''
    document.getElementById('job-f-type').value     = job.vacancy_type || ''
    document.getElementById('job-f-location').value = job.location || ''
    document.getElementById('job-f-active').value   = job.status || (job.active ? 'active' : 'inactive')
    document.getElementById('job-f-sal-min').value  = job.salary_min || ''
    document.getElementById('job-f-sal-max').value  = job.salary_max || ''
    document.getElementById('job-f-period').value   = job.pay_period || ''
    document.getElementById('job-f-email').value    = job.contact_email || ''
    document.getElementById('job-f-phone').value    = job.contact_phone || ''
    document.getElementById('job-f-desc').value     = job.description || ''
    document.getElementById('job-f-req').value      = job.requirements || ''
    document.getElementById('jobEditModal').classList.remove('hidden')
    document.body.style.overflow = 'hidden'
  }

  function closeJobEditModal() {
    document.getElementById('jobEditModal').classList.add('hidden')
    document.body.style.overflow = ''
  }

  async function saveJob() {
    const id = document.getElementById('job-edit-id').value
    const statusVal = document.getElementById('job-f-active').value
    const payload = {
      title:         document.getElementById('job-f-title').value.trim(),
      category:      document.getElementById('job-f-category').value || null,
      vacancy_type:  document.getElementById('job-f-type').value || null,
      location:      document.getElementById('job-f-location').value || null,
      status:        statusVal,
      active:        statusVal === 'active',
      description:   document.getElementById('job-f-desc').value.trim() || null,
      requirements:  document.getElementById('job-f-req').value.trim() || null,
      contact_email: document.getElementById('job-f-email').value.trim() || null,
      contact_phone: document.getElementById('job-f-phone').value.trim() || null,
      salary_min:    parseInt(document.getElementById('job-f-sal-min').value) || null,
      salary_max:    parseInt(document.getElementById('job-f-sal-max').value) || null,
      pay_period:    document.getElementById('job-f-period').value || null,
    }
    if (!payload.title || !payload.category || !payload.vacancy_type || !payload.location) {
      showToast('Please fill in all required fields.', 'error'); return
    }
    const btn = document.getElementById('job-save-btn')
    btn.disabled = true; btn.textContent = 'Saving…'
    const { error } = await sb.from('jobs').update(payload).eq('id', id)
    btn.disabled = false; btn.textContent = 'Save Changes'
    if (error) { showToast('Error: ' + error.message, 'error'); return }
    closeJobEditModal()
    showToast('Listing updated.')
    await loadAllJobs()
  }

  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeJobEditModal() })
</script>
</body>
</html>
